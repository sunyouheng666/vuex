/**
 * Justboil.me - a TinyMCE image upload plugin
 * jbimages/plugin.js
 *
 * Released under Creative Commons Attribution 3.0 Unported License
 *
 * License: http://creativecommons.org/licenses/by/3.0/
 * Plugin info: http://justboil.me/
 * Author: Viktor Kuzhelnyi
 *
 * Version: 2.3 released 23/06/2013
 */

tinymce.PluginManager.add('joinfimage', function(editor, url) {
	function pickImage(e) {
		var dom = editor.dom;
		var inputFile = $('<input type="file" name="imgFile" accept="image/jpg,image/jpeg,image/png,image/gif,image/bmp" multiple="multiple">');
		inputFile.on('change', function() {
			var form = $("<form/>", {
				action: editor.settings.images_upload_url,
				style: 'display:none',
				method: 'post',
				enctype: 'multipart/form-data'
			});
			form.append(inputFile);
			form.ajaxSubmit({
				beforeSubmit: function() {
					editor.fire("joinimageuploadstart");
					return true;
				},
				success: function(data) {
					editor.fire("joinimageuploadend");
					if(data.success){
						editor.focus();
						editor.selection.setContent(dom.createHTML('img', {
							src: data.data.url,
							'data-code': data.data.code 
						}));
					}
					else{
						editor.fire("joinimageuploaderror",{errMsg:data.errMsg});
					}
				},
				error: function(res) {
					editor.fire("joinimageuploaderror",{errMsg:"图片上传失败"});
				}
			});
		});

		inputFile.click();
	}

	editor.addCommand("mceUploadImageEditor", pickImage);

	// Add a button that opens a window
	editor.addButton('joinfimage', {
		tooltip: '插入图片',
		icon: 'image',
		text: '',
		onclick: pickImage
	});
	// Adds a menu item to the tools menu
	editor.addMenuItem('joinfimage', {
		text: 'Upload image',
		icon: 'image',
		context: 'insert',
		onclick: pickImage
	});
});